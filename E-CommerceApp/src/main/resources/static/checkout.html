<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout | RapidStore Official</title>
<link
	href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap"
	rel="stylesheet">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
	--primary: #2563eb;
	--black: #0f172a;
	--gray-100: #f8fafc;
	--gray-200: #e2e8f0;
	--gray-500: #64748b;
	--white: #ffffff;
	--transition: all 0.3s ease;
}

* {
	margin: 0;
	padding: 0;
	box-sizing: border-box;
	font-family: 'Plus Jakarta Sans', sans-serif;
}

body {
	background-color: var(--white);
	color: var(--black);
	line-height: 1.6;
}

.container {
	max-width: 1200px;
	margin: 0 auto;
	padding: 40px 24px;
}

/* Navbar Header */
.checkout-nav {
	height: 80px;
	display: flex;
	align-items: center;
	justify-content: center;
	border-bottom: 1px solid var(--gray-200);
	background: rgba(255, 255, 255, 0.8);
	backdrop-filter: blur(10px);
	position: sticky;
	top: 0;
	z-index: 100;
}

.logo {
	font-weight: 800;
	font-size: 1.5rem;
	text-decoration: none;
	color: var(--black);
	letter-spacing: -1px;
}

.logo span {
	color: var(--primary);
}

.checkout-grid {
	display: grid;
	grid-template-columns: 1.2fr 0.8fr;
	gap: 60px;
	margin-top: 40px;
}

h2 {
	font-size: 1.5rem;
	margin-bottom: 25px;
	font-weight: 800;
	letter-spacing: -0.5px;
}

/* Form Sections */
.form-section {
	background: var(--white);
	border: 1px solid var(--gray-200);
	padding: 30px;
	border-radius: 24px;
	margin-bottom: 30px;
}

.input-group {
	margin-bottom: 20px;
}

label.field-label {
	display: block;
	font-size: 0.75rem;
	font-weight: 700;
	margin-bottom: 8px;
	text-transform: uppercase;
	color: var(--gray-500);
	letter-spacing: 1px;
}

input, select {
	width: 100%;
	padding: 14px;
	border: 1px solid var(--gray-200);
	border-radius: 12px;
	font-size: 1rem;
	transition: var(--transition);
}

input:focus {
	outline: none;
	border-color: var(--primary);
	box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
}

.row {
	display: grid;
	grid-template-columns: 1fr 1fr;
	gap: 20px;
}

/* Payment Options Styling */
.payment-option {
	border: 1px solid var(--gray-200);
	border-radius: 15px;
	padding: 18px;
	margin-bottom: 15px;
	display: flex;
	align-items: center;
	gap: 15px;
	cursor: pointer;
	transition: var(--transition);
	position: relative;
}

.payment-option:hover {
	border-color: var(--primary);
	background: var(--gray-100);
}

.payment-option.active {
	border-color: var(--primary);
	background: #eff6ff;
}

.payment-option input[type="radio"] {
	width: 20px;
	height: 20px;
	cursor: pointer;
	accent-color: var(--primary);
}

.payment-option i {
	font-size: 1.3rem;
	width: 30px;
	color: var(--gray-500);
	text-align: center;
}

.payment-option.active i {
	color: var(--primary);
}

.payment-details-box {
	background: #f1f5f9;
	padding: 15px;
	border-radius: 12px;
	margin-top: 15px;
	display: none;
	width: 100%;
}

/* Order Review Card */
.order-review {
	background: var(--gray-100);
	padding: 40px;
	border-radius: 30px;
	height: fit-content;
	position: sticky;
	top: 120px;
}

.mini-item {
	display: flex;
	align-items: center;
	gap: 20px;
	margin-bottom: 25px;
	padding-bottom: 20px;
	border-bottom: 1px solid var(--gray-200);
}

.mini-item img {
	width: 80px;
	height: 80px;
	object-fit: cover;
	border-radius: 15px;
	background: white;
}

.mini-item-info h4 {
	font-size: 1rem;
	font-weight: 700;
	margin-bottom: 5px;
}

.mini-item-info p {
	font-size: 0.9rem;
	color: var(--gray-500);
}

.summary-totals {
	margin-top: 20px;
}

.total-row {
	display: flex;
	justify-content: space-between;
	margin-bottom: 12px;
	font-weight: 600;
	color: var(--gray-500);
}

.grand-total {
	font-size: 1.4rem;
	font-weight: 800;
	margin-top: 20px;
	padding-top: 20px;
	border-top: 2px solid var(--gray-200);
	color: var(--black);
}

.btn-pay {
	width: 100%;
	background: var(--black);
	color: white;
	padding: 20px;
	border: none;
	border-radius: 15px;
	font-weight: 800;
	font-size: 1.1rem;
	cursor: pointer;
	margin-top: 30px;
	transition: var(--transition);
}

.btn-pay:hover {
	background: var(--primary);
	transform: translateY(-3px);
	box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2);
}

/* Success Overlay */
#success-screen {
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background: white;
	display: none;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	z-index: 2000;
	text-align: center;
	padding: 20px;
}

.success-icon {
	font-size: 6rem;
	color: #10b981;
	margin-bottom: 20px;
}

@media ( max-width : 900px) {
	.checkout-grid {
		grid-template-columns: 1fr;
	}
	.order-review {
		position: static;
	}
}
</style>
</head>
<body>

	<header class="checkout-nav">
		<a href="products.html" class="logo">RAPID<span>STORE</span></a>
	</header>

	<div class="container">
		<div class="checkout-grid">
			<div class="checkout-form">
				<form id="payment-form">
					<div class="form-section">
						<h2>
							<i class="fa-solid fa-truck"></i> Shipping Details
						</h2>
						<div class="input-group">
							<label class="field-label">Full Name</label> <input type="text"
								id="custName" placeholder="John Doe" required>
						</div>
						<div class="input-group">
							<label class="field-label">Email Address</label> <input
								type="email" id="custEmail" placeholder="john@example.com"
								required>
						</div>
						<div class="input-group">
							<label class="field-label">Street Address</label> <input
								type="text" id="custStreet" 
								placeholder="123 Rapid Lane, Suite 4B" required>
						</div>
						<div class="row">
							<div class="input-group">
								<label class="field-label">City</label> <input type="text"
									id="custCity" placeholder="Pune" required>
							</div>
							<div class="input-group">
								<label class="field-label">Pincode</label> <input type="text"
									id="custPin" placeholder="411001" required>
							</div>
						</div>
					</div>

					<div class="form-section">
						<h2>
							<i class="fa-solid fa-wallet"></i> Payment Method
						</h2>

						<label class="payment-option"
							onclick="togglePaymentDetails('upi')"> <input
							type="radio" name="payMethod" value="UPI" required> <i
							class="fa-solid fa-mobile-screen-button"></i>
							<div style="flex-grow: 1;">
								<strong>UPI (GPay, PhonePe, BHIM)</strong>
								<div id="details-upi" class="payment-details-box">
									<input type="text"
										placeholder="Enter UPI ID (e.g. user@okhdfcbank)">
								</div>
							</div>
						</label> <label class="payment-option"
							onclick="togglePaymentDetails('card')"> <input
							type="radio" name="payMethod" value="Credit/Debit Card">
							<i class="fa-solid fa-credit-card"></i>
							<div style="flex-grow: 1;">
								<strong>Credit / Debit / ATM Card</strong>
								<div id="details-card" class="payment-details-box">
									<input type="text" placeholder="Card Number" maxlength="19"
										style="margin-bottom: 10px">
									<div class="row">
										<input type="text" placeholder="MM/YY" maxlength="5">
										<input type="password" placeholder="CVV" maxlength="3">
									</div>
								</div>
							</div>
						</label> <label class="payment-option"
							onclick="togglePaymentDetails('netbanking')"> <input
							type="radio" name="payMethod" value="Net Banking"> <i
							class="fa-solid fa-building-columns"></i>
							<div style="flex-grow: 1;">
								<strong>Net Banking</strong>
								<div id="details-netbanking" class="payment-details-box">
									<select>
										<option>Choose your Bank</option>
										<option>SBI</option>
										<option>HDFC Bank</option>
										<option>ICICI Bank</option>
										<option>Axis Bank</option>
									</select>
								</div>
							</div>
						</label> <label class="payment-option"
							onclick="togglePaymentDetails('COD')"> <input
							type="radio" name="payMethod" value="Cash on Delivery"> <i
							class="fa-solid fa-hand-holding-dollar"></i>
							<div style="flex-grow: 1;">
								<strong>Cash on Delivery (COD)</strong>
								<div id="details-COD" class="payment-details-box">No
									advance payment needed. Pay at your doorstep.</div>
							</div>
						</label>
					</div>

					<button type="submit" class="btn-pay" id="payButton">Complete
						Purchase</button>
				</form>
			</div>

			<div class="order-review">
				<h2>Order Summary</h2>
				<div id="review-items-list"></div>

				<div class="summary-totals">
					<div class="total-row">
						<span>Subtotal</span> <span id="review-subtotal">$0.00</span>
					</div>
					<div class="total-row">
						<span>Express Shipping</span> <span
							style="color: #10b981; font-weight: 800;">FREE</span>
					</div>
					<div class="total-row grand-total">
						<span>Total Payable</span> <span id="review-total">$0.00</span>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div id="success-screen">
		<div class="success-icon">
			<i class="fa-solid fa-circle-check"></i>
		</div>
		<h1 id="success-title">Order Confirmed!</h1>
		<p
			style="color: var(--gray-500); margin: 10px 0 30px; font-size: 1.1rem;">
			Thank you <span id="user-name-display"
				style="font-weight: 700; color: var(--black);"></span>! Your order
			is being processed via <span id="method-display"
				style="font-weight: 700"></span>.
		</p>
		<p style="color: var(--primary); font-weight: 600;">Redirecting to
			your orders...</p>
		<a href="orders.html" class="btn-pay"
			style="text-decoration: none; width: auto; padding: 15px 40px;">View
			My Orders</a>
	</div>

	<script>
        function getCartKey() {
            const user = JSON.parse(localStorage.getItem('rapidUser'));
            return user ? `rapidCart_${user.id}` : null;
        }

        let pendingItem = JSON.parse(localStorage.getItem('pendingOrder'));
        let grandTotal = 0;

        function renderReview() {
            const list = document.getElementById('review-items-list');
            const subtotalEl = document.getElementById('review-subtotal');
            const totalEl = document.getElementById('review-total');
            const cartKey = getCartKey();
            const cartItems = cartKey ? (JSON.parse(localStorage.getItem(cartKey)) || []) : [];
            
            let displayItems = [];
            
            if (pendingItem) {
                displayItems = [{
                    name: pendingItem.name,
                    price: pendingItem.price,
                    image: pendingItem.imageUrl || pendingItem.image_url || pendingItem.image,
                    quantity: pendingItem.selectedQuantity || 1
                }];
            } else if (cartItems.length > 0) {
                displayItems = cartItems;
            } else {
                window.location.href = "products.html";
                return;
            }

            grandTotal = 0;
            list.innerHTML = displayItems.map(item => {
                const itemTotal = item.price * (item.quantity || 1);
                grandTotal += itemTotal;
                const imgSrc = item.image_url || item.imageUrl || item.image;
                return `
                    <div class="mini-item">
                        <img src="${imgSrc}" alt="${item.name}">
                        <div class="mini-item-info">
                            <h4>${item.name}</h4>
                            <p>Qty: ${item.quantity || 1} â€¢ $${itemTotal.toFixed(2)}</p>
                        </div>
                    </div>
                `;
            }).join('');

            subtotalEl.innerText = `$${grandTotal.toFixed(2)}`;
            totalEl.innerText = `$${grandTotal.toFixed(2)}`;
            document.getElementById('payButton').innerText = `Confirm Order ($${grandTotal.toFixed(2)})`;
        }

        function togglePaymentDetails(type) {
            document.querySelectorAll('.payment-details-box').forEach(box => box.style.display = 'none');
            document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('active'));
            const selectedBox = document.getElementById('details-' + type);
            if (selectedBox) {
                selectedBox.style.display = 'block';
                selectedBox.closest('.payment-option').classList.add('active');
            }
        }

        document.getElementById('payment-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const user = JSON.parse(localStorage.getItem('rapidUser'));
            if (!user || !user.id) {
                alert("Session expired. Please login again.");
                window.location.href = "login.html";
                return;
            }

            const name = document.getElementById('custName').value;
            const street = document.getElementById('custStreet').value;
            const city = document.getElementById('custCity').value;
            const pin = document.getElementById('custPin').value;
            const fullAddress = `${street}, ${city} - ${pin}`;
            
            const method = document.querySelector('input[name="payMethod"]:checked').value;
            const cartKey = getCartKey();
            
            let itemsToOrder = [];
            if (pendingItem) {
                itemsToOrder = [{
                    name: pendingItem.name,
                    price: pendingItem.price,
                    image: pendingItem.imageUrl || pendingItem.image_url || pendingItem.image,
                    quantity: pendingItem.selectedQuantity || 1
                }];
            } else {
                itemsToOrder = JSON.parse(localStorage.getItem(cartKey)) || [];
            }

            try {
                // Loop through each item and send COMPLETE data to backend
                for (const item of itemsToOrder) {
                    const orderPayload = {
                        userId: user.id,
                        totalAmount: item.price * (item.quantity || 1),
                        productName: item.name,
                        productImage: item.image || item.imageUrl || item.image_url,
                        quantity: item.quantity || 1,
                        address: fullAddress
                    };

                    await fetch('http://localhost:8080/api/orders/place', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderPayload)
                    });
                }

                document.getElementById('user-name-display').innerText = name;
                document.getElementById('method-display').innerText = method;

                localStorage.removeItem('pendingOrder');
                if (!pendingItem && cartKey) localStorage.removeItem(cartKey);
                
                document.getElementById('success-screen').style.display = 'flex';
                setTimeout(() => { window.location.href = "orders.html"; }, 3000);

            } catch (error) {
                console.error("Backend Error:", error); 
                alert("Connection failed. Check if your Spring Boot server is running.");
            }
        });

        window.onload = renderReview;
    </script>
</body>
</html>